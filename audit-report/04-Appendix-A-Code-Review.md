# 4. 附录A：手动代码审查笔记

## 文件：`src/PriceConverter.sol`
- **第2行 (`pragma`)**: 使用 `^0.8.8`。注意到与主合约版本不一致，记录为信息类发现 I-01。
- **第8行 (地址常量)**: 硬编码Sepolia测试网预言机地址。思考：这限制了合约在多链部署的灵活性，记录为 I-02。
- **第12-22行 (`getPrice` 函数)**: **核心风险点**。
    - 观察到 `latestRoundData()` 返回5个值，但仅将 `answer` 赋值给变量。
    - **提问**：`updatedAt` (时间戳) 和 `answeredInRound` (轮次) 未被检查。如果预言机心跳停止或出现异常，合约会使用多久以前的价格？这构成了 **M-01**。
    - 第19行使用了魔数 `10000000000`，可读性差，记录为 I-03。
- **第25-35行 (`getConversionRate` 函数)**:
    - 数学计算正确。第30行使用 `1000000000000000000` 进行Wei到ETH的单位转换，同样是魔数问题 (I-03)。

## 文件：`src/FundMe.sol`
- **第2行 (`pragma`)**: `^0.8.18`，与库文件版本不一致 (I-01)。
- **第16行 (`MINIMUM_USD`)**: 定义为 `public` 常量，思考是否需要外部读取？倾向于更严格的可见性，记录为笔记。
- **第18行 (`constructor`)**:
    - 直接赋值 `i_owner = msg.sender`。**最佳实践检查**：是否应添加零地址校验？虽然 `msg.sender` 在常规交易中不为零，但作为通用模式应保持严谨，记录为 **L-01**。
- **第19行 (`s_priceFeed`)**: 状态变量在构造函数设置后不再更改。**优化思考**：是否应声明为 `immutable` 以节省Gas？Slither 后来也提示了这点 (I-04)。
- **第23-28行 (`fund` 函数)**:
    - 逻辑清晰。但注意到 `s_funders.push(msg.sender)` 可能导致同一地址被重复添加，使数组膨胀。这是设计取舍（允许同一地址多次资助），但加重了 M-02 的Gas问题。
- **第35-48行 (`withdraw` 函数)**:
    - `onlyOwner` 修饰器正确。
    - **第35-39行的 `for` 循环是主要审查重点**。思考：如果 `s_funders` 有1000个地址，此交易将消耗多少Gas？是否会超过区块限制？这形成了 **M-02** 的核心论据。
    - **第43-48行**: 使用 `call` 并检查 `callSuccess`，这是当前推荐的安全转账模式，良好。Slither 对此有提示 (I-05)，但我们的实现已处理返回值。
- **第50-56行 (`fallback`/`receive`)**:
    - 函数体为空。**设计疑问**：这允许ETH直接发送给合约而不调用 `fund()`。这些捐赠不会被记录在 `s_funders` 或 `addressToAmountFunded` 中，但可以通过 `call` 取出。这是有意设计还是疏忽？应在项目文档中明确。

## 文件：`test/FundMe.t.sol` (辅助理解)
- 测试覆盖了正常流程。但注意到**缺少针对审计发现的负面测试**：
    - 没有测试当预言机返回陈旧数据时合约的行为。
    - 没有对 `s_funders` 数组增长进行压力测试。
    - 记录此观察为信息类建议 **I-06**。
